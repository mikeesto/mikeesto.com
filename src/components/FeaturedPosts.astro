---
import { Redis } from "@upstash/redis";
import { getCollection } from "astro:content";
import { filterPosts } from "../utils/filterPosts";

const redis = new Redis({
  url: import.meta.env.UPSTASH_REDIS_REST_URL,
  token: import.meta.env.UPSTASH_REDIS_REST_TOKEN,
});

const posts = await getCollection("posts");
const latestPosts = filterPosts(posts).splice(0, 5);

// Batch fetch stars for latest 5 posts
const pipeline = redis.pipeline();
latestPosts.forEach((post) => pipeline.get(`stars:${post.slug}`));
const starCounts = await pipeline.exec();

const postsWithStars = latestPosts.map((post, i) => ({
  ...post,
  stars: Number(starCounts[i]) || 0,
}));
---

<div class="space-y-6">
  <ul class="space-y-4">
    {
      postsWithStars.map((post) => (
        <li class="group">
          <div class="flex justify-between items-start gap-6 md:gap-8">
            <div class="flex-1 min-w-0">
              {post.stars >= 10 && <span class="text-gray-400 text-sm">★</span>}
              <a
                class="text-blue-500 hover:text-blue-600 font-medium text-base leading-6 transition-colors duration-150"
                href={`/posts/${post.slug}`}
              >
                {post.data.title}
              </a>
              <p class="text-gray-600 mt-2 text-sm leading-5 line-clamp-2">
                {post.data.description}
              </p>
            </div>
            <div class="flex-shrink-0">
              <time class="text-gray-500 text-sm font-medium whitespace-nowrap">
                {post.data.formattedDate}
              </time>
            </div>
          </div>
        </li>
      ))
    }
  </ul>

  <div>
    <a
      href="/posts"
      class="inline-flex items-center gap-2 px-4 py-2.5 rounded-lg bg-gray-50 hover:bg-gray-100 border border-gray-300 hover:border-gray-400 transition-all duration-200 group text-sm font-medium"
    >
      <span class="text-gray-700">All posts</span>
      <span
        class="transition-transform duration-200 transform group-hover:translate-x-1 text-gray-500"
        aria-hidden="true"
      >
        →
      </span>
    </a>
  </div>
</div>
