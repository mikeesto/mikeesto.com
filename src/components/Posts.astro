---
import { readdirSync, readFileSync } from "fs";
import matter from "gray-matter";
import { compareDesc, parse, format } from "date-fns";
import yaml from "js-yaml";

const posts = [];
const files = readdirSync("src/pages/posts");

for (const file of files) {
  const data = readFileSync(`src/pages/posts/${file}`, "utf8");
  const frontmatter = matter(data, {
    engines: {
      yaml: (s) => yaml.load(s, { schema: yaml.JSON_SCHEMA }),
    },
  });

  // Exclude drafts
  if (frontmatter.data.draft) {
    continue;
  }

  // Parse frontmatter
  const slug = file.split(".")[0];
  const parsedDate = parse(frontmatter.data.date, "dd-MM-yyyy", new Date());
  const formattedDate = format(parsedDate, "PPP");

  posts.push({ ...frontmatter.data, slug, formattedDate });
}

posts.sort((post1, post2) =>
  compareDesc(
    parse(post1.date, "dd-MM-yyyy", new Date()),
    parse(post2.date, "dd-MM-yyyy", new Date())
  )
);
---

<ul>
  {posts.map((post) => (
    <li>
      <a href={`/posts/${post.slug}`}>
        {post.title} ({post.formattedDate})
      </a>
    </li>
  ))}
  <!-- Posts that live elsewhere -->
  <li>
    <a
      href="https://dev.to/mikeesto/next-js-mdx-w-code-highlighting-16fi"
      target="_blank">Next.js & MDX with code highlighting (July 16th, 2021)</a
    >
  </li>
  <li>
    <a
      href="https://mikeesto.medium.com/uploading-to-the-raspberry-pi-pico-without-thonny-53de1a10da30"
      target="_blank"
      >Uploading files to the Raspberry Pi Pico without Thonny (February 17th,
      2021)</a
    >
  </li>
  <li>
    <a
      href="https://dev.to/mikeesto/top-level-await-in-node-2jad"
      target="_blank"
    >
      Create React App Turns Four (October 29th, 2020)</a
    >
  </li>
  <li>
    <a
      href="https://dev.to/mikeesto/create-react-app-turns-four-3ace"
      target="_blank"
    >
      Top Level Await in Node (August 15th, 2020)</a
    >
  </li>
  <li>
    <a
      href="  https://dev.to/mikeesto/the-screen-wake-lock-api-51hp"
      target="_blank"
    >
      The Screen Wake Lock API (July 23rd, 2020)</a
    >
  </li>
</ul>

<style>
  ul {
    list-style: none;
    padding-left: 20px;
  }

  ul li::before {
    content: "\25AA"; /* Unicode for a square */
    color: var(--heading-color);
    font-weight: bold;
    display: inline-block;
    width: 1em;
    margin-left: -1em;
  }

  a {
    color: var(--posts-link);
    text-decoration: none;
    font-weight: 500;
  }

  a:hover {
    border-bottom: 1px dotted var(--posts-link);
  }
</style>
